<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricardos Track Viewer</title>
    <link rel="stylesheet" href="CSS/style.css">

</head>

<body>

    <header>
        <div
            style="width: 100%; max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 1.5rem 2rem;">
            <div>
                <button id="backBtn" class="header-btn" onclick="resetView()" style="display: none;">‚¨Ö Load New File</button>
                <button id="galleryBtn" class="header-btn" onclick="showGallery()" style="display: none;">‚¨Ö Back to Gallery</button>
            </div>
            <h1>Ricardos <span style="color: white; opacity: 0.8;">TRACK VIEWER</span></h1>
            <div></div> <!-- Spacer -->
        </div>
    </header>

    <div class="container">

        <div class="upload-zone" id="dropZone">
            <div class="upload-icon">üìÇ</div>
            <h3>Drag & Drop .thr file here</h3>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">or click to browse single file</p>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="document.getElementById('fileInput').click()" style="background-color: var(--surface-color); border: 1px solid var(--accent-color);">Select Single File</button>
                <button onclick="triggerFolderSelect()">Select Folder</button>
            </div>

            <input type="file" id="fileInput" accept=".thr">
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
        </div>

        <!-- NEW: Gallery View -->
        <div id="galleryView" class="gallery-view" style="display: none; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="margin: 0;">Track Library <span id="libraryCount" style="font-size: 1rem; color: var(--text-secondary); font-weight: normal;">(0 files)</span></h2>
                <input type="text" id="searchLibrary" placeholder="Search tracks..." style="padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; background: var(--surface-color); color: white;">
            </div>
            <div id="galleryGrid" class="gallery-grid">
                <!-- Thumbnails will be injected here -->
            </div>
        </div>

        <div class="workspace" id="workspace">
            <!-- Left: Canvas + Save -->
            <div style="display: flex; flex-direction: column; gap: 1.5rem; align-items: center;">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="trackCanvas" width="1200" height="1200"
                        style="position: absolute; top: 0; left: 0;"></canvas>
                    <canvas id="cursorCanvas" width="1200" height="1200"
                        style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                </div>
                <button onclick="downloadTrack()" style="width: 100%; padding: 1rem; font-size: 1.1rem; margin-top: auto;">üíæ Save Modified .thr</button>
            </div>

            <!-- Right: Sidebar (Stats + Controls) -->
            <div class="sidebar">

                <!-- Stats removed -->
                
                <div class="controls-row">
                    <!-- Controls moved here -->
                    <div id="controls" style="background: var(--surface-color); padding: 1.5rem; border-radius: 1rem;">
                        <h3 style="margin-top: 0; margin-bottom: 1.5rem;">Modify Track</h3>

                        <!-- Start Position Toggle -->
                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Start
                                Position (Cleaning Direction)</label>
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; color: white; cursor: pointer;">
                                    <input type="radio" name="startPos" value="center" checked
                                        onchange="applyRotations()" style="accent-color: var(--accent-color);">
                                    Center (0,0) ‚Üí Outward
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; color: white; cursor: pointer;">
                                    <input type="radio" name="startPos" value="edge" onchange="applyRotations()"
                                        style="accent-color: var(--accent-color);">
                                    Edge (1,0) ‚Üí Inward
                                </label>
                            </div>
                            <!-- Pre-Clean Checkbox -->
                            <div style="margin-top: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; color: #94a3b8; cursor: pointer; font-size: 0.9rem;">
                                    <input type="checkbox" id="preCleanCheck" onchange="handlePreCleanChange()"
                                        style="accent-color: #94a3b8;">
                                    Pre-Clean (Wipe)
                                </label>
                                <button onclick="normalizeTrack()"
                                    style="background-color: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.4rem;">Reset to 0</button>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <!-- Cleaning Circles Slider -->
                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.25rem; font-size: 0.875rem;">Cleaning
                                Circles (Integer)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                                <input type="range" id="circlesSlider" min="-100" max="100" step="1" value="0"
                                    style="flex: 1; accent-color: var(--accent-color);">
                                <input type="number" id="circlesInput" min="-100" max="100" step="1" value="0"
                                    style="width: 60px; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--text-secondary); color: white; border-radius: 0.5rem; text-align: center;">
                            </div>

                            <!-- Fine Rotation Slider -->
                            <div style="margin-bottom: 0.75rem;">
                                <!-- Fine Rotation Slider -->
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 0.25rem; font-size: 0.875rem;">Fine
                                    Rotation (0-360¬∞)</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                                    <input type="range" id="fineSlider" min="0" max="360" step="1" value="0"
                                        style="flex: 1; accent-color: var(--accent-color);">
                                    <input type="number" id="fineInput" min="0" max="360" step="1" value="0"
                                        style="width: 60px; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--text-secondary); color: white; border-radius: 0.5rem; text-align: center;">
                                </div>

                                <!-- Track Thickness Slider -->
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 0.25rem; font-size: 0.875rem;">Track
                                    Thickness & Style</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="range" id="thicknessSlider" min="1" max="50" step="1" value="15"
                                        style="flex: 1; accent-color: var(--accent-color);">
                                    <span id="thicknessValue"
                                        style="color: var(--text-secondary); font-size: 0.9rem; width: 30px; text-align: right;">15px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Playback Controls -->
                        <div
                            style="margin-bottom: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Playback</label>

                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button id="playBtn" onclick="togglePlay()"
                                    style="flex: 2; background-color: var(--accent-color);">‚ñ∂ Play</button>
                                <button onclick="stopPlay()" style="flex: 1; background-color: #334155; color: white;">‚ñ†
                                    Stop</button>
                            </div>

                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem;">Progress</label>
                            <input type="range" id="progressSlider" min="0" max="100" value="0"
                                style="width: 100%; accent-color: var(--accent-color); margin-bottom: 1rem;">

                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem;">Speed</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="range" id="speedSlider" min="1" max="100" step="1" value="10"
                                    style="flex: 1; accent-color: var(--accent-color);">
                                <span id="speedValue"
                                    style="color: var(--text-secondary); font-size: 0.8rem; width: 40px; text-align: right;">10x</span>
                            </div>
                        </div>

                    </div>

                    <!-- Code Preview -->
                    <div
                        style="background: var(--surface-color); padding: 1.5rem; border-radius: 1rem; display: flex; flex-direction: column; flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <h3 style="margin: 0;">Code Preview & Edit</h3>
                                <span id="headerPointCount" style="color: var(--text-secondary); font-size: 0.9rem; font-weight: normal;">(0 pts)</span>
                            </div>
                            <button onclick="toggleHelp()" style="background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; padding: 0;">?</button>
                        </div>
                        <pre id="codePreview"
                            style="background: var(--bg-color); padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.8rem; overflow: hidden; flex: 1; margin: 0; color: #a5b4fc;"></pre>
                        
                        <!-- Auto-Fix Controls -->
                        <div id="rangeActions" style="display: none; margin-top: 1rem; background: rgba(244, 63, 94, 0.1); padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(244, 63, 94, 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="color: #f43f5e; font-size: 0.85rem; font-weight: bold;">Range Selected (<span id="rangeCount">0</span> pts)</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="applySmoothing()" style="flex: 1; background-color: #f43f5e; color: white; border: none;">Apply Smooth</button>
                                <button onclick="cancelRange()" style="flex: 1; background-color: transparent; border: 1px solid #f43f5e; color: #f43f5e;">Cancel</button>
                            </div>
                        </div>

                        <!-- Auto-Fix Controls -->
                        <div style="margin-top: 1rem; background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">Smoothing Distance (Detection)</label>
                                <span id="windowValue" style="font-size: 0.75rem; color: var(--accent-color);">25</span>
                            </div>
                            <input type="range" id="fixWindow" min="5" max="100" step="1" value="25" oninput="document.getElementById('windowValue').textContent = this.value" style="width: 100%; accent-color: var(--accent-color);">
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-size: 0.75rem; color: var(--text-secondary);">Corner Protection (Sensitivity)</label>
                                <span id="protectValue" style="font-size: 0.75rem; color: var(--accent-color);">0.90</span>
                            </div>
                            <input type="range" id="fixProtect" min="0.1" max="0.99" step="0.01" value="0.90" oninput="document.getElementById('protectValue').textContent = parseFloat(this.value).toFixed(2)" style="width: 100%; accent-color: var(--accent-color);">
                        </div>

                        <div style="margin-top: 0.75rem; display: flex; gap: 0.4rem; align-items: center;">
                            <button onclick="autoFixTrack()" style="flex: 1; background-color: var(--surface-color); border: 1px solid var(--accent-color); color: var(--accent-color); white-space: nowrap; padding-left: 0.5rem; padding-right: 0.5rem; font-size: 0.9rem;">ü™Ñ Auto-Smooth</button>
                            <input type="number" id="fixStrength" value="0.025" step="0.001" min="0.001" max="1" style="width: 55px; padding: 0.75rem 0.25rem; background: var(--bg-color); border: 1px solid var(--text-secondary); color: white; border-radius: 0.5rem; text-align: center; font-size: 0.85rem;" title="Smooth Intensity">
                            <button id="undoBtn" onclick="undo()" style="width: 65px; background-color: var(--surface-color); border: 1px solid var(--text-secondary); color: var(--text-primary); padding-left: 0.25rem; padding-right: 0.25rem; font-size: 0.8rem;">‚Ü© (0)</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- FIX START MODAL -->
    <div id="fixStartModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top: 0; color: var(--accent-color);">Start Position Suspicious</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.5;">
                This track does not start at <strong>0,0</strong> (Center) or <strong>0,1</strong> (Edge).<br>
                It starts at a rotated position, which might be incorrect.
            </p>
            <p style="color: white; margin-bottom: 2rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.5rem; font-family: monospace;"
                id="modalCurrentStart">
                Current Start: ?
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="confirmFixStart(true)"
                    style="background-color: var(--accent-color); color: var(--bg-color);">
                    ‚úÖ Yes, Add Start Point
                </button>
                <button onclick="confirmFixStart(false)"
                    style="background-color: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);">
                    No, keep as is
                </button>
            </div>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; color: var(--accent-color);">How to Edit Tracks</h2>
                <button onclick="toggleHelp()" style="background: transparent; color: var(--text-secondary); font-size: 1.5rem; padding: 0;">&times;</button>
            </div>
            
            <div style="color: var(--text-primary); line-height: 1.6; font-size: 0.95rem;">
                <h4 style="color: #38bdf8; margin-bottom: 0.5rem; margin-top: 0;">Navigation</h4>
                <ul style="margin-top: 0; color: var(--text-secondary);">
                    <li><strong>Blue Cursor:</strong> Shows the current playback position.</li>
                    <li><strong>Scroll Wheel:</strong> Hover over the Code Preview list and scroll to move the blue cursor frame-by-frame.</li>
                    <li><strong>Slider:</strong> Drag the progress bar to jump quickly.</li>
                </ul>

                <h4 style="color: #f43f5e; margin-bottom: 0.5rem;">Selection & Deletion</h4>
                <ul style="margin-top: 0; color: var(--text-secondary);">
                    <li><strong>Red Cursor (Select):</strong> Click on any line in the code list to select it. A <strong>red dot</strong> will appear on the track. This is your target for editing.</li>
                    <li><strong>Delete Point:</strong> Once selected (Red), click the <strong>Trash Icon (üóëÔ∏è)</strong> in the list or <strong>Right-Click</strong> the red line to remove the point.</li>
                    <li><strong>Undo:</strong> Made a mistake? Press <strong>Ctrl + Z</strong> to undo your last change.</li>
                </ul>
            </div>

            <div style="margin-top: 2rem; text-align: center;">
                <button onclick="toggleHelp()" style="background-color: var(--surface-color); border: 1px solid var(--text-secondary);">Close Help</button>
            </div>
        </div>
    </div>

    <script src="JS/track-viewer.js" defer></script>
</body>

</html>